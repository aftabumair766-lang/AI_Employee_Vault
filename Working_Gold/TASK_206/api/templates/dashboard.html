<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Employee Vault - Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 20px 30px;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 1.5rem; color: #60a5fa; }
        .header .status {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-healthy { background: #065f46; color: #34d399; }
        .status-error { background: #7f1d1d; color: #fca5a5; }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            padding: 24px;
        }
        .card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-2px); border-color: #60a5fa; }
        .card h3 {
            font-size: 0.85rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }
        .card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #f8fafc;
        }
        .card .subtitle { font-size: 0.8rem; color: #64748b; margin-top: 4px; }

        .card-green .value { color: #34d399; }
        .card-blue .value { color: #60a5fa; }
        .card-yellow .value { color: #fbbf24; }
        .card-red .value { color: #f87171; }
        .card-purple .value { color: #a78bfa; }

        .section-title {
            font-size: 1.1rem;
            color: #94a3b8;
            padding: 16px 24px 0;
            font-weight: 600;
        }

        .task-table {
            margin: 0 24px 24px;
            background: #1e293b;
            border-radius: 12px;
            border: 1px solid #334155;
            overflow: hidden;
        }
        table { width: 100%; border-collapse: collapse; }
        th {
            background: #334155;
            padding: 12px 16px;
            text-align: left;
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #94a3b8;
        }
        td { padding: 12px 16px; border-top: 1px solid #334155; font-size: 0.9rem; }
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-done { background: #065f46; color: #34d399; }
        .badge-progress { background: #1e3a5f; color: #60a5fa; }
        .badge-pending { background: #713f12; color: #fbbf24; }
        .badge-failed { background: #7f1d1d; color: #fca5a5; }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #334155;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .progress-green { background: linear-gradient(90deg, #059669, #34d399); }
        .progress-blue { background: linear-gradient(90deg, #2563eb, #60a5fa); }

        .security-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #334155;
        }
        .metric-row:last-child { border-bottom: none; }
        .metric-label { color: #94a3b8; font-size: 0.85rem; }
        .metric-value { color: #f8fafc; font-weight: 600; font-size: 0.85rem; }

        .auto-refresh { font-size: 0.75rem; color: #64748b; }
        .footer {
            text-align: center;
            padding: 20px;
            color: #475569;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>AI Employee Vault</h1>
            <span class="auto-refresh">Auto-refresh: 10s</span>
        </div>
        <span class="status status-healthy" id="systemStatus">HEALTHY</span>
    </div>

    <!-- Overview Cards -->
    <div class="grid">
        <div class="card card-green">
            <h3>Tasks Completed</h3>
            <div class="value" id="tasksCompleted">-</div>
            <div class="subtitle" id="tasksTotal">of - total</div>
        </div>
        <div class="card card-blue">
            <h3>Test Coverage</h3>
            <div class="value">73%</div>
            <div class="progress-bar"><div class="progress-fill progress-blue" style="width:73%"></div></div>
        </div>
        <div class="card card-purple">
            <h3>Security Score</h3>
            <div class="value">81/100</div>
            <div class="subtitle">+47% improvement</div>
        </div>
        <div class="card card-yellow">
            <h3>Total Tests</h3>
            <div class="value">360</div>
            <div class="subtitle">100% pass rate</div>
        </div>
        <div class="card card-green">
            <h3>API Uptime</h3>
            <div class="value" id="uptime">-</div>
            <div class="subtitle" id="totalRequests">- requests</div>
        </div>
        <div class="card card-red">
            <h3>Error Rate</h3>
            <div class="value" id="errorRate">0%</div>
            <div class="subtitle" id="totalErrors">0 errors</div>
        </div>
    </div>

    <!-- Security Modules -->
    <h2 class="section-title">Security Modules (TASK_204 Skills)</h2>
    <div class="grid security-grid">
        <div class="card">
            <h3>PathValidator</h3>
            <div class="metric-row">
                <span class="metric-label">CVSS Fixed</span>
                <span class="metric-value">7.5</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Coverage</span>
                <span class="metric-value">56.86%</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Tests</span>
                <span class="metric-value">45</span>
            </div>
        </div>
        <div class="card">
            <h3>ArchiveEncryption</h3>
            <div class="metric-row">
                <span class="metric-label">CVSS Fixed</span>
                <span class="metric-value">8.0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Coverage</span>
                <span class="metric-value">73.21%</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Tests</span>
                <span class="metric-value">60</span>
            </div>
        </div>
        <div class="card">
            <h3>InputValidator</h3>
            <div class="metric-row">
                <span class="metric-label">CVSS Fixed</span>
                <span class="metric-value">7.0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Coverage</span>
                <span class="metric-value">45.58%</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Tests</span>
                <span class="metric-value">50</span>
            </div>
        </div>
        <div class="card">
            <h3>IntegrityChecker</h3>
            <div class="metric-row">
                <span class="metric-label">CVSS Fixed</span>
                <span class="metric-value">6.5</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Coverage</span>
                <span class="metric-value">62.50%</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Tests</span>
                <span class="metric-value">40</span>
            </div>
        </div>
        <div class="card">
            <h3>SecureLogging</h3>
            <div class="metric-row">
                <span class="metric-label">CVSS Fixed</span>
                <span class="metric-value">6.0</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Coverage</span>
                <span class="metric-value">37.14%</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Tests</span>
                <span class="metric-value">30</span>
            </div>
        </div>
        <div class="card">
            <h3>ApprovalVerifier</h3>
            <div class="metric-row">
                <span class="metric-label">CVSS Fixed</span>
                <span class="metric-value">7.5</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Coverage</span>
                <span class="metric-value">17.90%</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Tests</span>
                <span class="metric-value">35</span>
            </div>
        </div>
    </div>

    <!-- Tasks Table -->
    <h2 class="section-title">Task History (Gold Level)</h2>
    <div class="task-table">
        <table>
            <thead>
                <tr>
                    <th>Task ID</th>
                    <th>Description</th>
                    <th>Status</th>
                    <th>Duration</th>
                </tr>
            </thead>
            <tbody id="taskTableBody">
                <tr><td colspan="4" style="text-align:center;color:#64748b">Loading...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- System Resources -->
    <h2 class="section-title">System Resources (Live)</h2>
    <div class="grid">
        <div class="card">
            <h3>CPU Usage</h3>
            <div class="value" id="cpuUsage">-</div>
            <div class="progress-bar"><div class="progress-fill progress-green" id="cpuBar" style="width:0%"></div></div>
        </div>
        <div class="card">
            <h3>Memory Usage</h3>
            <div class="value" id="memUsage">-</div>
            <div class="progress-bar"><div class="progress-fill progress-blue" id="memBar" style="width:0%"></div></div>
        </div>
        <div class="card">
            <h3>Disk Usage</h3>
            <div class="value" id="diskUsage">-</div>
            <div class="progress-bar"><div class="progress-fill progress-green" id="diskBar" style="width:0%"></div></div>
        </div>
    </div>

    <div class="footer">
        AI Employee Vault v1.0 | Powered by FastAPI + SQLAlchemy | Skills: TASK_204 Security Modules
    </div>

    <script>
        async function fetchData() {
            try {
                // Fetch metrics
                const metricsRes = await fetch('/api/v1/metrics');
                const metrics = await metricsRes.json();

                // Update uptime
                document.getElementById('uptime').textContent = metrics.uptime || '-';
                document.getElementById('totalRequests').textContent = (metrics.total_requests || 0) + ' requests';
                document.getElementById('errorRate').textContent = (metrics.error_rate_percent || 0) + '%';
                document.getElementById('totalErrors').textContent = (metrics.total_errors || 0) + ' errors';

                // System resources
                if (metrics.system) {
                    const cpu = metrics.system.cpu_percent || 0;
                    const mem = metrics.system.memory?.percent || 0;
                    const disk = metrics.system.disk?.percent || 0;

                    document.getElementById('cpuUsage').textContent = cpu + '%';
                    document.getElementById('cpuBar').style.width = cpu + '%';
                    document.getElementById('memUsage').textContent = mem + '%';
                    document.getElementById('memBar').style.width = mem + '%';
                    document.getElementById('diskUsage').textContent = disk + '%';
                    document.getElementById('diskBar').style.width = disk + '%';
                }

                // Fetch tasks
                const tasksRes = await fetch('/api/v1/tasks');
                const tasksData = await tasksRes.json();
                const tasks = tasksData.tasks || [];

                const completed = tasks.filter(t => t.status === 'DONE' || t.status === 'COMPLETED').length;
                document.getElementById('tasksCompleted').textContent = completed;
                document.getElementById('tasksTotal').textContent = `of ${tasks.length} total`;

                // Populate table
                const tbody = document.getElementById('taskTableBody');
                tbody.innerHTML = tasks.map(t => `
                    <tr>
                        <td><strong>${t.task_id}</strong></td>
                        <td>${t.description}</td>
                        <td><span class="badge ${getBadgeClass(t.status)}">${t.status}</span></td>
                        <td>${t.duration || '-'}</td>
                    </tr>
                `).join('');

                // Health status
                const healthRes = await fetch('/health');
                const health = await healthRes.json();
                const statusEl = document.getElementById('systemStatus');
                statusEl.textContent = health.status === 'healthy' ? 'HEALTHY' : 'ERROR';
                statusEl.className = 'status ' + (health.status === 'healthy' ? 'status-healthy' : 'status-error');

            } catch (err) {
                console.error('Dashboard fetch error:', err);
                document.getElementById('systemStatus').textContent = 'OFFLINE';
                document.getElementById('systemStatus').className = 'status status-error';
            }
        }

        function getBadgeClass(status) {
            const map = {
                'DONE': 'badge-done', 'COMPLETED': 'badge-done',
                'IN_PROGRESS': 'badge-progress', 'NEEDS_ACTION': 'badge-pending',
                'FAILED': 'badge-failed', 'BLOCKED': 'badge-failed'
            };
            return map[status] || 'badge-pending';
        }

        // Initial fetch + auto-refresh every 10s
        fetchData();
        setInterval(fetchData, 10000);
    </script>
</body>
</html>
